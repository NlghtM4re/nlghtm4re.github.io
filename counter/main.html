<!DOCTYPE html>
<html>
<head>
  <title>🌍 Global Counter</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    🌍 Global Counter
    <div class="header-right">
      <span id="username-display">Name: ...</span> | 
      <span>Your clicks: <span id="personal-count">0</span></span>
    </div>
  </header>

  <div class="left-panel">
    <h3>💬 Global Chat</h3>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input">
      <input type="text" id="chat-input" placeholder="Type a message...">
      <button id="chat-send">Send</button>
    </div>
  </div>

  <div class="center">
    <h2 id="count">Loading...</h2>
    <button id="btn">+1</button>
  </div>

  <div class="right-panel">
    <div id="leaderboard">
      <h3>🏆 Leaderboard</h3>
      <ul id="leaderboard-list"></ul>
    </div>
    <div id="my-rank">Your rank: -</div>
    <button id="change-name">Change Name</button>
  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, set, get, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

document.addEventListener("DOMContentLoaded", () => {
  const firebaseConfig = {
    apiKey: "AIzaSyAQ8hwInUpT050ZgOY3J5IHwXXByPhS5uI",
    authDomain: "counter-7e3e2.firebaseapp.com",
    databaseURL: "https://counter-7e3e2-default-rtdb.firebaseio.com",
    projectId: "counter-7e3e2",
    storageBucket: "counter-7e3e2.firebasestorage.app",
    messagingSenderId: "1095835005773",
    appId: "1:1095835005773:web:26b3b279d52dbb2e64fd04",
    measurementId: "G-PKK7P26S6D"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // DOM
  const countEl = document.getElementById("count");
  const btn = document.getElementById("btn");
  const usernameDisplay = document.getElementById("username-display");
  const personalCountEl = document.getElementById("personal-count");
  const leaderboardList = document.getElementById("leaderboard-list");
  const myRankEl = document.getElementById("my-rank");
  const changeNameBtn = document.getElementById("change-name");

  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");
  const chatMessages = document.getElementById("chat-messages");

  // Firebase refs
  const countRef = ref(db, "counter/value");
  const leaderboardRef = ref(db, "leaderboard");
  const chatRef = ref(db, "chat");

  let username = localStorage.getItem("username");
  let personalClicks = parseInt(localStorage.getItem("personalClicks") || 0);
  let unsyncedClicks = 0;

  async function askName() {
    let name;
    let oldName = username;
    while (true) {
      name = prompt("Enter your name (max 20 characters):") || username || "Guest" + Math.floor(Math.random()*1000);
      name = name.substring(0,20);

      const snapshot = await get(ref(db, `leaderboard/${name}`));
      if (!snapshot.exists() || name === oldName) break;
      alert("This name is already taken. Please choose another one.");
    }

    // Remove old name from database
    if(oldName && oldName !== name) remove(ref(db, `leaderboard/${oldName}`));

    username = name;
    localStorage.setItem("username", username);
    updateNameDisplay();
    updateLeaderboard();
  }

  function updateNameDisplay() {
    usernameDisplay.textContent = `Name: ${username}`;
    personalCountEl.textContent = personalClicks;
  }

  onValue(countRef, snapshot => {
    countEl.textContent = snapshot.val() ?? 0;
  });

  onValue(leaderboardRef, snapshot => {
    const data = snapshot.val() || {};
    const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]);

    leaderboardList.innerHTML = sorted.map(([name, score], index)=>{
      let rankClass = "";
      if(index===0) rankClass="rank-1";
      else if(index===1) rankClass="rank-2";
      else if(index===2) rankClass="rank-3";

      return `<li${name===username?' style="color: var(--accent); font-weight:bold;"':''}>
                <span class="rank ${rankClass}">${index+1}</span>
                <span>${name}: ${score}</span>
              </li>`;
    }).join("");

    const rank = sorted.findIndex(([name])=>name===username)+1;
    myRankEl.textContent = rank>0?`Your rank: ${rank} / ${sorted.length}`:"Your rank: -";
  });

  btn.addEventListener("click", ()=>{
    runTransaction(countRef, current => (current||0)+1);
    personalClicks++;
    unsyncedClicks++;
    localStorage.setItem("personalClicks", personalClicks);
    updateNameDisplay();

    if(unsyncedClicks>=5){
      updateLeaderboard();
      unsyncedClicks=0;
    }
  });

  setInterval(()=>{
    if(unsyncedClicks>0){
      updateLeaderboard();
      unsyncedClicks=0;
    }
  },10000);

  changeNameBtn.addEventListener("click", askName);

  function updateLeaderboard(){
    set(ref(db, "leaderboard/"+username), personalClicks);
  }

  // CHAT
  function sendMessage(){
    let msg = chatInput.value.trim();
    if(msg==="") return;
    if(msg.length>200) msg = msg.substring(0,200);

    const messageData = {user: username, text: msg, timestamp: Date.now()};
    set(ref(db, `chat/${messageData.timestamp}`), messageData);

    chatInput.value="";
  }

  chatSend.addEventListener("click", sendMessage);
  chatInput.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  onValue(chatRef, snapshot=>{
    const data = snapshot.val() || {};
    const messages = Object.values(data)
      .sort((a,b)=>a.timestamp-b.timestamp)
      .slice(-50);

    chatMessages.innerHTML = messages.map(msg=>{
      const cls = msg.user===username?"self":"";
      return `<div class="${cls}"><strong>${msg.user}:</strong> ${msg.text}</div>`;
    }).join("");
  });

  // INIT
  if(!username) askName();
  else updateNameDisplay();
});

  </script>
</body>
</html>


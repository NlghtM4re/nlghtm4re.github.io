<!DOCTYPE html>
<html>
<head>
  <title>🌍 Global Counter</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    🌍 Global Counter
    <div class="header-right">
      <span id="username-display">Name: ...</span> | 
      <span>Your clicks: <span id="personal-count">0</span></span>
    </div>
  </header>

  <div class="left-panel">
    <h3>Chat</h3>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input">
      <input type="text" id="chat-input" placeholder="Type a message...">
      <button id="chat-send">Send</button>
    </div>
  </div>

  <div class="center">
    <h2 id="count">Loading...</h2>
    <button id="btn">+1</button>
  </div>

  <div class="right-panel">
    <div id="leaderboard">
      <h3>🏆 Leaderboard</h3>
      <ul id="leaderboard-list"></ul>
    </div>
    <div id="my-rank">Your rank: -</div>
    <button id="change-name">Change Name</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, set, get, push, remove, query, limitToLast } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAQ8hwInUpT050ZgOY3J5IHwXXByPhS5uI",
  authDomain: "counter-7e3e2.firebaseapp.com",
  databaseURL: "https://counter-7e3e2-default-rtdb.firebaseio.com",
  projectId: "counter-7e3e2",
  storageBucket: "counter-7e3e2.firebasestorage.app",
  messagingSenderId: "1095835005773",
  appId: "1:1095835005773:web:26b3b279d52dbb2e64fd04",
  measurementId: "G-PKK7P26S6D"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const countEl = document.getElementById("count");
const btn = document.getElementById("btn");
const usernameDisplay = document.getElementById("username-display");
const personalCountEl = document.getElementById("personal-count");
const leaderboardList = document.getElementById("leaderboard-list");
const myRankEl = document.getElementById("my-rank");
const changeNameBtn = document.getElementById("change-name");
const chatMessages = document.getElementById("chat-messages");
const chatInput = document.getElementById("chat-input");
const chatSend = document.getElementById("chat-send");

const countRef = ref(db, "counter/value");
const leaderboardRef = ref(db, "leaderboard");
const chatRef = ref(db, "chat");

let username = localStorage.getItem("username");
let personalClicks = parseInt(localStorage.getItem("personalClicks") || 0);
let unsyncedClicks = 0;

// Change name function
async function askName() {
  let oldUsername = username;
  let name;
  while(true) {
    name = prompt("Enter your name:", username);
    if(name === null) return; // Cancel, keep current name
    if(name.trim() === "") continue;
    const snapshot = await get(ref(db, `leaderboard/${name}`));
    if(!snapshot.exists()) break;
    alert("This name is already taken. Choose another.");
  }
  username = name;
  localStorage.setItem("username", username);
  updateNameDisplay();

  // Delete old name from DB if changed
  if(oldUsername && oldUsername !== username) {
    remove(ref(db, `leaderboard/${oldUsername}`));
  }

  // Update leaderboard with current clicks (does not reset)
  updateLeaderboard();
  alert("Your name has been changed.");
}

function updateNameDisplay() {
  usernameDisplay.textContent = `Name: ${username}`;
  personalCountEl.textContent = personalClicks;
}

// Global counter
onValue(countRef, snapshot => {
  countEl.textContent = snapshot.val() ?? 0;
});

// Leaderboard
onValue(leaderboardRef, snapshot => {
  const data = snapshot.val() || {};
  const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]);
  leaderboardList.innerHTML = sorted.map(([name,score])=>
    `<li${name===username?' style="color: var(--accent); font-weight:bold;"':''}>${name}: ${score}</li>`
  ).join("");
  const rank = sorted.findIndex(([name])=>name===username)+1;
  myRankEl.textContent = rank>0?`Your rank: ${rank} / ${sorted.length}`:"Your rank: -";
});

// Click +1
btn.addEventListener("click", ()=>{
  runTransaction(countRef, c=>(c||0)+1);
  personalClicks++;
  unsyncedClicks++;
  localStorage.setItem("personalClicks", personalClicks);
  updateNameDisplay();
  if(unsyncedClicks >= 5){
    updateLeaderboard();
    unsyncedClicks = 0;
  }
});

setInterval(()=>{
  if(unsyncedClicks>0){
    updateLeaderboard();
    unsyncedClicks=0;
  }
},10000);

changeNameBtn.addEventListener("click", askName);

function updateLeaderboard(){
  set(ref(db,"leaderboard/"+username), personalClicks);
}

// Chat
chatSend.addEventListener("click", ()=>{
  const msg = chatInput.value.trim();
  if(msg!==""){
    push(chatRef, {name: username, message: msg}).then(() => {
      // Keep only last 50 messages
      const q = query(chatRef, limitToLast(51));
      onValue(q, snapshot => {
        const vals = snapshot.val() || {};
        const keys = Object.keys(vals);
        if(keys.length > 50){
          remove(ref(db,"chat/"+keys[0])); // delete oldest
        }
      }, {onlyOnce:true});
    });
    chatInput.value="";
  }
});

onValue(query(chatRef, limitToLast(50)), snapshot=>{
  const data = snapshot.val()||{};
  chatMessages.innerHTML = Object.values(data).map(m=>`<div><strong>${m.name}:</strong> ${m.message}</div>`).join("");
  chatMessages.scrollTop = chatMessages.scrollHeight;
});

// Initialize
if(!username) askName();
else updateNameDisplay();

  </script>
</body>
</html>
